#!/bin/bash
# Small-Hacker LXC Proxy Master (Learned from Pro Config)
set -e
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; CYAN='\033[0;36m'; NC='\033[0m'
WORKDIR="$HOME/.cyber-proxy"; BIN_DIR="$WORKDIR/bin"; CONFIG_FILE="$WORKDIR/config.json"
SB_BINARY="$BIN_DIR/sing-box"; CF_BINARY="$BIN_DIR/cloudflared"; CERT_DIR="$WORKDIR/cert"

get_arch() { case "$(uname -m)" in x86_64) echo "amd64" ;; aarch64) echo "arm64" ;; *) echo "unknown" ;; esac; }
init_dirs() { mkdir -p "$BIN_DIR" "$CERT_DIR"; }

download_components() {
    local ARCH=$(get_arch)
    if [ ! -f "$SB_BINARY" ]; then
        local LATEST_SB=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep tag_name | cut -d '"' -f 4 | sed 's/v//')
        curl -L "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_SB}/sing-box-${LATEST_SB}-linux-${ARCH}.tar.gz" -o /tmp/sb.tar.gz
        tar -xzf /tmp/sb.tar.gz -C /tmp && find /tmp -name "sing-box" -type f -exec mv {} "$SB_BINARY" \; && chmod +x "$SB_BINARY"
    fi
    if [ ! -f "$CF_BINARY" ]; then
        curl -L "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${ARCH}" -o "$CF_BINARY" && chmod +x "$CF_BINARY"
    fi
}

generate_dual_config() {
    local vless_port=$1; local tuic_port=$2; local uuid=$(cat /proc/sys/kernel/random/uuid)
    local vless_path="/$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 12)"
    local tuic_pass=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 24) # 学习点: 独立长密码
    
    mkdir -p "$WORKDIR" "$CERT_DIR"
    openssl req -x509 -nodes -newkey rsa:2048 -keyout "$CERT_DIR/privkey.pem" -out "$CERT_DIR/cert.pem" -days 3650 -subj "/CN=www.bing.com" 2>/dev/null
    
    cat > "$CONFIG_FILE" <<EOF
{
  "log": { "level": "error" },
  "inbounds": [
    { 
      "type": "vless", "tag": "vless-in", "listen": "127.0.0.1", "listen_port": $vless_port, 
      "users": [{ "uuid": "$uuid" }], 
      "transport": { "type": "ws", "path": "$vless_path" } 
    },
    { 
      "type": "tuic", "tag": "tuic-in", "listen": "::", "listen_port": $tuic_port, 
      "users": [{ "uuid": "$uuid", "password": "$tuic_pass" }], 
      "congestion_control": "bbr",
      "zero_rtt_handshake": true,
      "tls": { 
        "enabled": true, "certificate_path": "$CERT_DIR/cert.pem", "key_path": "$CERT_DIR/privkey.pem",
        "alpn": ["h3"]
      } 
    }
  ],
  "outbounds": [{ "type": "direct" }]
}
EOF
    echo "$uuid" > "$WORKDIR/uuid.txt"; echo "$vless_path" > "$WORKDIR/vless_path.txt"; echo "$vless_port" > "$WORKDIR/vless_port.txt"
    echo "$tuic_pass" > "$WORKDIR/tuic_pass.txt"; echo "$tuic_port" > "$WORKDIR/tuic_port.txt"
}

setup_services() {
    local user_name=$(whoami); local vless_port=$(cat "$WORKDIR/vless_port.txt"); local argo_token=$(cat "$WORKDIR/argo_token.txt" 2>/dev/null || echo "")
    sudo systemctl stop cyber-sb cyber-argo 2>/dev/null || true
    sudo tee /etc/systemd/system/cyber-sb.service > /dev/null <<EOF
[Unit]
Description=Cyber SB
After=network.target
[Service]
ExecStart=$SB_BINARY run -c $CONFIG_FILE
Restart=always
User=$user_name
WorkingDirectory=$WORKDIR
[Install]
WantedBy=multi-user.target
EOF
    local argo_cmd="$CF_BINARY tunnel --url http://127.0.0.1:$vless_port"
    [ -n "$argo_token" ] && argo_cmd="$CF_BINARY tunnel run --token $argo_token"
    sudo tee /etc/systemd/system/cyber-argo.service > /dev/null <<EOF
[Unit]
Description=Cyber Argo
After=network.target
[Service]
ExecStart=$argo_cmd
Restart=always
User=$user_name
WorkingDirectory=$WORKDIR
[Install]
WantedBy=multi-user.target
EOF
sudo systemctl daemon-reload && sudo systemctl enable --now cyber-sb cyber-argo
}

show_results() {
    echo -e "\n${GREEN}=== 部署完成 ===${NC}"
    local uuid=$(cat "$WORKDIR/uuid.txt"); local path=$(cat "$WORKDIR/vless_path.txt"); local preferred="saas.sin.fan"; local fixed_domain=$(cat "$WORKDIR/argo_domain.txt" 2>/dev/null || echo "")
    if [ -n "$fixed_domain" ]; then
        echo -e "Vless链接: vless://${uuid}@${preferred}:443?encryption=none&security=tls&sni=${fixed_domain}&host=${fixed_domain}&fp=chrome&type=ws&path=$(echo $path | sed 's/\//%2F/g')#Argo_Fixed"
    else
        echo -e "${YELLOW}等待 Argo (8s)...${NC}" && sleep 8
        local raw_domain=$(sudo journalctl -u cyber-argo --no-hostname -n 50 | grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare\.com' | tail -1 | sed 's#https://##')
        echo -e "Vless链接: vless://${uuid}@${preferred}:443?encryption=none&security=tls&sni=${raw_domain}&host=${raw_domain}&fp=chrome&type=ws&path=$(echo $path | sed 's/\//%2F/g')#Argo_Temp"
    fi
    local tuic_port=$(cat "$WORKDIR/tuic_port.txt"); local tuic_pass=$(cat "$WORKDIR/tuic_pass.txt"); local ip=$(curl -s ifconfig.me)
    # 学习点: 格式完全模拟图中成功的样子
    echo -e "\n${CYAN}[2] TUIC v5 (UDP专精)${NC}"
    echo -e "IP: $ip, 端口: $tuic_port"
    echo -e "TUIC链接: tuic://${uuid}:${tuic_pass}@${ip}:${tuic_port}?congestion_control=bbr&alpn=h3&sni=www.bing.com&udp_relay_mode=native&allow_insecure=1#TUIC_LXC"
}

clear
echo -e "${CYAN}Small-Hacker LXC Master (Argo+TUIC)${NC}"
echo "1. 安装服务"; echo "2. 查看链接"; echo "3. 卸载"; echo "4. 退出"
read -p "指令: " choice < /dev/tty
case $choice in
    1)
        init_dirs && download_components
        read -p "Argo模式 (1.临时 2.固定): " am < /dev/tty
        if [ "$am" == "2" ]; then read -p "Token: " tk < /dev/tty; read -p "域名: " dm < /dev/tty; echo "$tk" > "$WORKDIR/argo_token.txt"; echo "$dm" > "$WORKDIR/argo_domain.txt"; else rm -f "$WORKDIR/argo_token.txt" "$WORKDIR/argo_domain.txt"; fi
        read -p "Vless本地端口: " vp < /dev/tty; [ -z "$vp" ] && vp=$(shuf -i 10000-20000 -n 1)
        read -p "TUIC外部端口: " tp < /dev/tty; [ -z "$tp" ] && tp=$(shuf -i 20000-60000 -n 1)
        generate_dual_config $vp $tp && setup_services && show_results ;;
    2) show_results ;;
    3) sudo systemctl disable --now cyber-sb cyber-argo 2>/dev/null || true; rm -rf "$WORKDIR"; echo "清理完毕。";;
    *) exit 0 ;;
esac
